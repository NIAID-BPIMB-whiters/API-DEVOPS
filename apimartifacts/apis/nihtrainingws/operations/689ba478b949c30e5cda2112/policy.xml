<!--
    - Policies are applied in the order they appear.
    - Position <base/> inside a section to inherit policies from the outer scope.
    - Comments within policies are not preserved.
-->
<!-- Add policies as children to the <inbound>, <outbound>, <backend>, and <on-error> elements -->
<policies>
	<!-- Throttle, authorize, validate, cache, or transform the requests -->
	<inbound>
		<base />
		<set-header name="Content-Type" exists-action="override">
			<value>text/xml; charset=utf-8</value>
		</set-header>
		<set-header name="SOAPAction" exists-action="override">
			<value>"/Traininginfo/V3/TrainingDataV3.serviceagent/PortTypeEndpoint0/getByName"</value>
		</set-header>
		<!-- Load Named Values into variables to avoid braces inside expressions -->
		<set-variable name="soapUsername" value="{{NIHTrainingWSUserName}}" />
		<set-variable name="soapPassword" value="@(System.Net.WebUtility.HtmlEncode("{{NIHTrainingWSPassword}}"))" />
		<!-- Transform incoming request to SOAP envelope -->
		<set-body><![CDATA[@{
            // Get query parameters or request body for NIH ID
            string firstName = "";
			string lastName = "";
            string getCoursesVal = "true";   // default
            string getModulesVal = "false";  // default

            try
            {
                var xmlText = context.Request.Body.As<string>(preserveContent: true);
                
                var xmlDoc = new System.Xml.XmlDocument();
                xmlDoc.LoadXml(xmlText);
                var nsMgr = new System.Xml.XmlNamespaceManager(xmlDoc.NameTable);
                nsMgr.AddNamespace("s", "http://schemas.xmlsoap.org/soap/envelope/");
                nsMgr.AddNamespace("nih", "http://www.nih.gov/schemas/HR/NIHTrainingInformationv3.xsd");
                
                var FirstNameNode = xmlDoc.SelectSingleNode("//nih:firstName", nsMgr) ?? xmlDoc.SelectSingleNode("//*[local-name()='firstName']");
                if (FirstNameNode != null)
                {
                    firstName = (FirstNameNode.InnerText ?? string.Empty).Trim();
                }
				
				var LastNameNode = xmlDoc.SelectSingleNode("//nih:lastName", nsMgr) ?? xmlDoc.SelectSingleNode("//*[local-name()='lastName']");
                if (LastNameNode != null)
                {
                    lastName = (LastNameNode.InnerText ?? string.Empty).Trim();
                }

                // getCourses
                var gcNode = xmlDoc.SelectSingleNode("//nih:getCourses", nsMgr) ?? xmlDoc.SelectSingleNode("//*[local-name()='getCourses']");
                if (gcNode != null)
                {
                    getCoursesVal = ((gcNode.InnerText ?? string.Empty).Trim().Equals("true", StringComparison.OrdinalIgnoreCase)) ? "true" : "false";
                }

                // getModules
                var gmNode = xmlDoc.SelectSingleNode("//nih:getModules", nsMgr) ?? xmlDoc.SelectSingleNode("//*[local-name()='getModules']");
                if (gmNode != null)
                {
                    getModulesVal = ((gmNode.InnerText ?? string.Empty).Trim().Equals("true", StringComparison.OrdinalIgnoreCase)) ? "true" : "false";
                }
                
            }
            catch { /* ignore invalid XML */ }
            
            // Generate unique token ID
            string tokenId = "UsernameToken-" + Guid.NewGuid().ToString().Replace("-", "").ToUpper();
            
            var soapUsername = (context.Variables["soapUsername"] as string) ?? string.Empty;
            var soapPassword = (context.Variables["soapPassword"] as string) ?? string.Empty;
                                 
            // Build SOAP envelope
            var sb = new System.Text.StringBuilder();
            sb.Append("<?xml version=\"1.0\" encoding=\"utf-8\"?>");
            sb.Append("<soapenv:Envelope xmlns:nih=\"http://www.nih.gov/schemas/HR/NIHTrainingInformationv3.xsd\" xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\">");
            sb.Append("<soapenv:Header>");
            sb.Append("<wsse:Security soapenv:mustUnderstand=\"1\" xmlns:wsse=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd\" xmlns:wsu=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd\">");
            sb.Append("<wsse:UsernameToken wsu:Id=\"" + tokenId + "\">");
            sb.Append("<wsse:Username>"+ soapUsername +"</wsse:Username>");
            sb.Append("<wsse:Password Type=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0#PasswordText\">"+ soapPassword +"</wsse:Password>");
            sb.Append("</wsse:UsernameToken>");
            sb.Append("</wsse:Security>");
            sb.Append("</soapenv:Header>");
            sb.Append("<soapenv:Body>");
            sb.Append("<nih:requestByName>");
            sb.Append("<nih:firstName>" + firstName + "</nih:firstName>");
			sb.Append("<nih:lastName>" + lastName + "</nih:lastName>");
            sb.Append("<nih:getCourses>" + getCoursesVal + "</nih:getCourses>");
            sb.Append("<nih:getModules>" + getModulesVal + "</nih:getModules>");
            sb.Append("</nih:requestByName>");
            sb.Append("</soapenv:Body>");
            sb.Append("</soapenv:Envelope>");
            
            return sb.ToString();

        }]]></set-body>
	</inbound>
	<!-- Control if and how the requests are forwarded to services  -->
	<backend>
		<base />
	</backend>
	<!-- Customize the responses -->
	<outbound>
		<base />
	</outbound>
	<!-- Handle exceptions and customize error responses  -->
	<on-error>
		<base />
	</on-error>
</policies>