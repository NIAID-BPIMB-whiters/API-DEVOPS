# =============================================================================
# SANDBOX ENVIRONMENT - PUBLISHER CONFIGURATION
# =============================================================================
# TARGET ENVIRONMENT: SANDBOX (niaid-bpimb-apim-sb)
# 
# This file configures how the publisher deploys artifacts TO the SANDBOX environment.
# 
# PURPOSE: Experimental/POC development environment
# - Test new APIs, policies, and configurations
# - Proof of concept development
# - Breaking change testing
# - Feature experimentation
# 
# PROMOTION PATH: Sandbox → DEV (manual, selective)
# - Successful POCs are manually promoted to DEV
# - See ARCHITECTURE-CHANGES-JAN2026.md for promotion procedures
# - NOT part of automated extraction workflow (DEV → QA → PROD)
# 
# Pipeline: Manual changes in Sandbox → Test → Manual promotion to DEV
# =============================================================================

# =============================================================================
# CONFIGURATION CAPABILITIES
# =============================================================================
# WHAT THIS CONFIGURATION FILE CAN DO:
# ✅ Remap APIM service name (apimServiceName)
# ✅ Remap named value Key Vault references (namedValues.properties.keyVault)
# ✅ Remap backend service URLs (backends.properties.url)
# ✅ Override API properties (apis.properties.path, protocols, etc.)
# ✅ Token substitution in artifacts using {{named-value-name}} syntax
# ✅ Exclude specific artifacts from deployment (apis, products, etc.)
# ✅ Override diagnostic verbosity levels (apis.diagnostics.properties.verbosity)
#
# WHAT THIS CONFIGURATION FILE CANNOT DO:
# ❌ Remap logger resource IDs in diagnostic configurations
#    Workaround: Use standardized logger names across all environments
# ❌ Remap self-hosted gateway names
#    Workaround: Use standardized gateway names or exclude from config
# ❌ Remap product IDs in subscription references
#    Workaround: Manually clean up subscriptions or use standardized product names
# ❌ Modify API operation paths or methods
#    Must be changed in OpenAPI specification files
# ❌ Remap policy XML resource references dynamically
#    Use named values for environment-specific values in policies instead
#
# APIops Version: v6.0.2
# See: https://github.com/Azure/apiops for feature documentation
# =============================================================================

apimServiceName: niaid-bpimb-apim-sb  # TARGET: SANDBOX APIM Service

namedValues:
  # Remap Key Vault references to SANDBOX environment
  # Repository may contain DEV references - remap to sandbox Key Vault
  # PLACEHOLDER: Update with actual Sandbox Key Vault name once created
  - name: apim-ai-connection-string
    properties:
      keyVault:
        secretIdentifier: https://kv-niaid-bpimb-apim-sb.vault.azure.net/secrets/apim-ai-connection-string

loggers:
  # NOTE: APIops v6.0.2 does NOT support remapping logger resource IDs in diagnostics
  # This configuration creates/updates the logger itself, but diagnostic configs
  # that reference loggers by name will use the logger name from the repository.
  # 
  # SANDBOX LOGGING STRATEGY:
  # - Use same logger name as DEV/QA for consistency
  # - Points to Sandbox-specific Application Insights instance
  # - Allows testing of logging/diagnostics configurations
  - name: apim-daids-connect-ai
    properties:
      loggerType: applicationInsights
      # PLACEHOLDER: Update with actual Sandbox resource IDs once created
      resourceId: /subscriptions/18fc6b8b-44fa-47d7-ae51-36766ac67165/resourceGroups/niaid-bpimb-apim-sb-rg/providers/Microsoft.Insights/components/niaid-bpimb-apim-sb-ai
      credentials:
        connectionString: "{{niaid-bpimb-apim-sb-ai-connection-string}}"

diagnostics:
  # Sandbox-specific diagnostic configurations can be added here
  # Example: Enable verbose logging for all APIs in sandbox for debugging
  # - name: applicationinsights
  #   properties:
  #     verbosity: verbose

backends:
  # Remap backend service URLs for Sandbox environment
  # 
  # SANDBOX BACKEND STRATEGY:
  # Option 1: Use same backends as DEV (default)
  # Option 2: Use sandbox-specific backend services (for isolation)
  # Option 3: Use mock/test backends
  # 
  # Add backend overrides here when Sandbox has different backend services:
  # - name: opentext-mcp-sop-policies-backend
  #   properties:
  #     url: https://sandbox-backend.example.com
  #     # Note: For HTTPS backends with self-signed certs in sandbox, 
  #     # may need to disable cert validation (NOT recommended for DEV/QA/PROD)

# =============================================================================
# SOAP/WSDL API MANAGEMENT NOTES
# =============================================================================
# Microsoft has documented that the current version of Azure APIops (v6.0.2) 
# does NOT support SOAP/WSDL APIs for automated deployment via publisher tool.
# 
# WSDL APIs must be deployed and managed manually through the Azure Portal.
# 
# For SOAP API testing in Sandbox:
# - Deploy manually through Azure Portal APIM interface
# - Test WSDL configurations before promoting to DEV
# - Do not add SOAP/WSDL specification files to this repository
# - APIops will ignore any manually deployed SOAP APIs in the portal
# =============================================================================

apis:
  # API-specific configuration overrides for Sandbox environment
  # 
  # SANDBOX API CONFIGURATION PATTERNS:
  # 
  # 1. Enable verbose diagnostics for debugging:
  # - name: test-api
  #   diagnostics:
  #     - name: applicationinsights
  #       properties:
  #         verbosity: verbose
  #
  # 2. Override API path for sandbox isolation:
  # - name: test-api
  #   properties:
  #     path: sandbox/test  # Isolates sandbox API from DEV/QA/PROD
  #
  # 3. Exclude production-critical APIs from sandbox:
  # Uncomment to prevent certain APIs from being deployed to sandbox
  # - name: critical-prod-api
  #   exclude: true
  #
  # 4. Override subscription requirement for testing:
  # - name: test-api
  #   properties:
  #     subscriptionRequired: false  # Easier testing without keys

# =============================================================================
# SANDBOX ENVIRONMENT NOTES
# =============================================================================
# 
# SANDBOX USE CASES:
# ✅ POC development and testing
# ✅ Breaking change validation
# ✅ New API development before promoting to DEV
# ✅ Policy testing and experimentation
# ✅ Load/performance testing without affecting DEV
# ✅ Training and learning environment
# 
# SANDBOX LIMITATIONS:
# ⚠️ Not monitored as strictly as DEV/QA/PROD
# ⚠️ May have lower SLA/availability
# ⚠️ May be reset/cleaned periodically
# ⚠️ Changes not automatically promoted (manual process)
# ⚠️ Not included in automated DEV → QA → PROD pipeline
# 
# PROMOTION TO DEV:
# When a POC is successful in Sandbox, use manual promotion process:
# See ARCHITECTURE-CHANGES-JAN2026.md "Promotion Path: Sandbox → DEV"
# Methods:
# - Method 1: Manual file copy (recommended for simple changes)
# - Method 2: Azure Portal manual configuration (for complex changes)
# - Method 3: Extractor-based with selective promotion
# - Method 4: Infrastructure as Code with promotion scripts
# 
# RESOURCE NAMING:
# - APIM Service: niaid-bpimb-apim-sb
# - Resource Group: niaid-bpimb-apim-sb-rg
# - Key Vault: kv-niaid-bpimb-apim-sb (to be created)
# - App Insights: niaid-bpimb-apim-sb-ai (to be created)
# - Service Principal: apiops-sb-sp (to be created)
# 
# GITHUB ENVIRONMENT:
# - Environment Name: apim-bpimb-sb
# - Approval Environment: approve-apim-bpimb-sb
# - Deployment Tags: deploy-sb-{timestamp}-{sha}
# 
# =============================================================================
