name: Test - APIs

# =============================================================================
# API TESTING WORKFLOW
# =============================================================================
# This workflow tests API functionality in different environments (dev/prod)
# Validates that APIs are reachable and responding correctly through APIM
# =============================================================================

on:
  workflow_dispatch:
    inputs:
      ENVIRONMENT:
        description: 'Environment to test'
        required: true
        type: choice
        options:
          - dev    # Tests against dev APIM (apim-daids-connect)
          - prod   # Tests against prod APIM (niaid-bpimb-apim-dev)
      API_NAME:
        description: 'API to test (leave empty to test all APIs)'
        required: false
        type: string
      TEST_TYPE:
        description: 'Type of test to run'
        required: true
        type: choice
        default: 'health-check'
        options:
          - health-check           # Quick gateway availability check
          - endpoint-availability  # Tests all API endpoints are reachable
          - full-suite            # Runs all available tests

env:
  # Fallback list of APIs used if APIM query fails
  # The workflow now dynamically queries APIM for current APIs by default
  # This static list ensures testing can still proceed if Azure CLI fails
  ALL_APIS: "crms-api-qa,demo-conference-api,echo-api,merlin-db,opentext,otcs-mcp-server,test"

jobs:
  # =============================================================================
  # SETUP JOB
  # =============================================================================
  # Configures environment-specific settings and determines which APIs to test
  # Outputs are used by subsequent test jobs
  # Uses self-hosted runner for dev (internal network) or GitHub-hosted for prod
  # =============================================================================
  setup:
    runs-on: ${{ github.event.inputs.ENVIRONMENT == 'dev' && 'self-hosted' || 'ubuntu-latest' }}
    outputs:
      apim-gateway: ${{ steps.config.outputs.apim-gateway }}  # APIM gateway URL for the selected environment
      apis-to-test: ${{ steps.config.outputs.apis-to-test }}  # Comma-separated list of APIs to test
    environment: ${{ github.event.inputs.ENVIRONMENT }}  # Required for Azure authentication
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure environment settings
        id: config
        env:
          API_MANAGEMENT_SERVICE_NAME: ${{ secrets.API_MANAGEMENT_SERVICE_NAME }}
          AZURE_RESOURCE_GROUP_NAME: ${{ secrets.AZURE_RESOURCE_GROUP_NAME }}
        run: |
          # Set APIM gateway URL based on selected environment
          if ("${{ github.event.inputs.ENVIRONMENT }}" -eq "prod") {
            # Production APIM instance
            "apim-gateway=niaid-bpimb-apim-dev.azure-api.net" >> $env:GITHUB_OUTPUT
          } else {
            # Development APIM instance (default)
            "apim-gateway=apim-daids-connect.azure-api.net" >> $env:GITHUB_OUTPUT
          }
          
          # Determine which APIs to test
          if ([string]::IsNullOrEmpty("${{ github.event.inputs.API_NAME }}")) {
            # No specific API provided - dynamically query all current APIs from APIM
            Write-Host "No specific API provided. Querying all current APIs from APIM..."
            
            $apimApis = & az apim api list `
              --resource-group "$env:AZURE_RESOURCE_GROUP_NAME" `
              --service-name "$env:API_MANAGEMENT_SERVICE_NAME" `
              --query "[?isCurrent==\`true\`].name" `
              -o tsv
            
            if ($LASTEXITCODE -ne 0) {
              Write-Host "[ERROR] Failed to query APIM APIs. Falling back to static list."
              "apis-to-test=${{ env.ALL_APIS }}" >> $env:GITHUB_OUTPUT
            } else {
              $apiList = ($apimApis | Where-Object { $_ -and $_.Trim() } | Sort-Object) -join ","
              Write-Host "Found APIs in APIM: $apiList"
              "apis-to-test=$apiList" >> $env:GITHUB_OUTPUT
            }
          } else {
            # Test only the specified API
            "apis-to-test=${{ github.event.inputs.API_NAME }}" >> $env:GITHUB_OUTPUT
          }
        shell: pwsh

  # =============================================================================
  # HEALTH CHECK JOB
  # =============================================================================
  # Quick test to verify the APIM gateway is responding
  # Tests the base gateway URL without hitting specific API endpoints
  # Uses self-hosted runner for dev (internal network) or GitHub-hosted for prod
  # =============================================================================
  test-health-check:
    needs: setup
    runs-on: ${{ github.event.inputs.ENVIRONMENT == 'dev' && 'self-hosted' || 'ubuntu-latest' }}
    # Only run if health-check or full-suite test type is selected
    if: ${{ github.event.inputs.TEST_TYPE == 'health-check' || github.event.inputs.TEST_TYPE == 'full-suite' }}
    environment: ${{ github.event.inputs.ENVIRONMENT }}
    steps:
      - name: Test APIM Gateway Health
        run: |
          Write-Host "Testing APIM Gateway: ${{ needs.setup.outputs.apim-gateway }}"
          
          # Send HTTP request to gateway and capture response code
          try {
            $response = Invoke-WebRequest -Uri https://${{ needs.setup.outputs.apim-gateway }} -Method Get -UseBasicParsing -ErrorAction SilentlyContinue
            $statusCode = $response.StatusCode
          } catch {
            if ($_.Exception.Response) {
              $statusCode = $_.Exception.Response.StatusCode.value__
            } else {
              # DNS or network error
              Write-Host "[FAIL] Cannot reach APIM gateway - DNS/network error: $($_.Exception.Message)"
              exit 1
            }
          }
          
          # Gateway is healthy if it responds with common HTTP codes
          # 404, 401, 403 are expected since we're not providing API path or credentials
          if ($statusCode -in @(404, 401, 403)) {
            Write-Host "[OK] APIM Gateway is responding (HTTP $statusCode)"
          } else {
            Write-Host "[FAIL] APIM Gateway health check failed (HTTP $statusCode)"
            exit 1
          }
        shell: pwsh

  # =============================================================================
  # ENDPOINT AVAILABILITY TESTS
  # =============================================================================
  # Tests each API endpoint to verify it's accessible through the gateway
  # Uses matrix strategy to test multiple APIs in parallel
  # Reads API specification files to determine correct base paths
  # Uses self-hosted runner for dev (internal network) or GitHub-hosted for prod
  # =============================================================================
  test-endpoint-availability:
    needs: setup
    runs-on: ${{ github.event.inputs.ENVIRONMENT == 'dev' && 'self-hosted' || 'ubuntu-latest' }}
    # Only run if endpoint-availability or full-suite test type is selected
    if: ${{ github.event.inputs.TEST_TYPE == 'endpoint-availability' || github.event.inputs.TEST_TYPE == 'full-suite' }}
    environment: ${{ github.event.inputs.ENVIRONMENT }}
    strategy:
      matrix:
        # Create parallel jobs for each API from setup output
        # Converts comma-separated string to JSON array format
        api: ${{ fromJson(format('["{0}"]', needs.setup.outputs.apis-to-test)) }}
      # Don't cancel remaining tests if one fails
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      
      # Extract base path from API specification file
      # Each API may have a different base URL pattern
      - name: Get API base path
        id: api-info
        run: |
          # Read API specification to get base path
          $specFile = "apimartifacts/apis/${{ matrix.api }}/specification.yaml"
          
          if (Test-Path $specFile) {
            # Extract base path from OpenAPI spec (basic parsing)
            $content = Get-Content $specFile -Raw
            if ($content -match '- url:\s*(.+)') {
              $url = $matches[1].Trim('"')
              # Remove hostname and variables
              $basePath = $url -replace 'https?://[^/]*', '' -replace '\{[^}]*\}', ''
              if ([string]::IsNullOrEmpty($basePath)) { $basePath = "/${{ matrix.api }}" }
              "base-path=$basePath" >> $env:GITHUB_OUTPUT
              Write-Host "API base path: $basePath"
            } else {
              "base-path=/${{ matrix.api }}" >> $env:GITHUB_OUTPUT
              Write-Host "Using default base path: /${{ matrix.api }}"
            }
          } else {
            # Fall back to API name as path if spec not found
            "base-path=/${{ matrix.api }}" >> $env:GITHUB_OUTPUT
            Write-Host "Using default base path: /${{ matrix.api }}"
          }
        shell: pwsh
      
      # Send HTTP request to API and verify it responds
      - name: Test API endpoint availability
        run: |
          Write-Host "Testing API: ${{ matrix.api }}"
          Write-Host "Gateway: https://${{ needs.setup.outputs.apim-gateway }}${{ steps.api-info.outputs.base-path }}"
          
          # Send request and capture HTTP response code
          try {
            $response = Invoke-WebRequest -Uri "https://${{ needs.setup.outputs.apim-gateway }}${{ steps.api-info.outputs.base-path }}" -Method Get -UseBasicParsing -ErrorAction SilentlyContinue
            $statusCode = $response.StatusCode
          } catch {
            $statusCode = $_.Exception.Response.StatusCode.value__
          }
          
          Write-Host "Response code: $statusCode"
          
          # Accept any response that indicates API is reachable
          # 200: Success, 401: Auth required, 403: Forbidden, 404: Method not found
          # These codes indicate the API gateway is routing requests correctly
          if ($statusCode -in @(200, 401, 403, 404)) {
            Write-Host "[OK] API endpoint is reachable"
          } else {
            Write-Host "[FAIL] API endpoint test failed (HTTP $statusCode)"
            exit 1
          }
        shell: pwsh

  # =============================================================================
  # TEST SUMMARY JOB
  # =============================================================================
  # Generates a summary report in GitHub Actions UI
  # Displays test results, environment info, and pass/fail status
  # Runs always, even if previous tests fail
  # Uses self-hosted runner for dev (internal network) or GitHub-hosted for prod
  # =============================================================================
  test-summary:
    needs: [setup, test-health-check, test-endpoint-availability]
    runs-on: ${{ github.event.inputs.ENVIRONMENT == 'dev' && 'self-hosted' || 'ubuntu-latest' }}
    # Always run summary, even if tests fail
    if: always()
    steps:
      - name: Generate test summary
        run: |
          # Create formatted summary in GitHub Actions step summary UI
          "## API Test Results" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "**Environment:** ${{ github.event.inputs.ENVIRONMENT }}" >> $env:GITHUB_STEP_SUMMARY
          "**Gateway:** ${{ needs.setup.outputs.apim-gateway }}" >> $env:GITHUB_STEP_SUMMARY
          "**Test Type:** ${{ github.event.inputs.TEST_TYPE }}" >> $env:GITHUB_STEP_SUMMARY
          "**APIs Tested:** ${{ needs.setup.outputs.apis-to-test }}" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          
          # Display health check result if it ran
          if ("${{ needs.test-health-check.result }}" -eq "success") {
            "[OK] Health Check: **Passed**" >> $env:GITHUB_STEP_SUMMARY
          } elseif ("${{ needs.test-health-check.result }}" -eq "failure") {
            "[FAIL] Health Check: **Failed**" >> $env:GITHUB_STEP_SUMMARY
          }
          
          # Display endpoint availability result if it ran
          if ("${{ needs.test-endpoint-availability.result }}" -eq "success") {
            "[OK] Endpoint Availability: **Passed**" >> $env:GITHUB_STEP_SUMMARY
          } elseif ("${{ needs.test-endpoint-availability.result }}" -eq "failure") {
            "[FAIL] Endpoint Availability: **Failed**" >> $env:GITHUB_STEP_SUMMARY
          }
        shell: pwsh
