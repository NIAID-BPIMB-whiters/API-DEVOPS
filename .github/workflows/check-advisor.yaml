name: Azure Advisor Compliance Check

# =============================================================================
# AZURE ADVISOR MONITORING WORKFLOW
# =============================================================================
# This workflow monitors Azure Advisor recommendations for compliance tracking
# Runs weekly and can be triggered manually for on-demand compliance checks
# Checks both DEV and PROD environments
# =============================================================================

on:
  # Run weekly on Mondays at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'
  
  # Allow manual execution
  workflow_dispatch:

jobs:
  check-advisor-dev:
    name: Check DEV Environment
    runs-on: ubuntu-latest
    environment: dev
    
    steps:
      - name: Azure Login
        run: |
          az login --service-principal \
            --username ${{ secrets.AZURE_CLIENT_ID }} \
            --password ${{ secrets.AZURE_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Get Azure Advisor Recommendations
        id: advisor
        run: |
          # Get all recommendations for the resource group
          echo "Checking DEV resource group: ${{ secrets.AZURE_RESOURCE_GROUP_NAME }}"
          
          RECOMMENDATIONS=$(az advisor recommendation list \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP_NAME }} \
            --query "[].{Category:category, Impact:impact, Problem:shortDescription.problem, Resource:impactedValue}" \
            --output json)
          
          echo "Raw recommendations count: $(echo "$RECOMMENDATIONS" | jq 'length')"
          
          # Count by impact level
          HIGH_COUNT=$(echo "$RECOMMENDATIONS" | jq '[.[] | select(.Impact=="High")] | length')
          MEDIUM_COUNT=$(echo "$RECOMMENDATIONS" | jq '[.[] | select(.Impact=="Medium")] | length')
          LOW_COUNT=$(echo "$RECOMMENDATIONS" | jq '[.[] | select(.Impact=="Low")] | length')
          TOTAL_COUNT=$((HIGH_COUNT + MEDIUM_COUNT + LOW_COUNT))
          
          # Count by category
          SECURITY_COUNT=$(echo "$RECOMMENDATIONS" | jq '[.[] | select(.Category=="Security")] | length')
          COST_COUNT=$(echo "$RECOMMENDATIONS" | jq '[.[] | select(.Category=="Cost")] | length')
          PERFORMANCE_COUNT=$(echo "$RECOMMENDATIONS" | jq '[.[] | select(.Category=="Performance")] | length')
          RELIABILITY_COUNT=$(echo "$RECOMMENDATIONS" | jq '[.[] | select(.Category=="HighAvailability")] | length')
          
          # Set outputs
          echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "medium_count=$MEDIUM_COUNT" >> $GITHUB_OUTPUT
          echo "low_count=$LOW_COUNT" >> $GITHUB_OUTPUT
          echo "total_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
          echo "security_count=$SECURITY_COUNT" >> $GITHUB_OUTPUT
          echo "cost_count=$COST_COUNT" >> $GITHUB_OUTPUT
          echo "performance_count=$PERFORMANCE_COUNT" >> $GITHUB_OUTPUT
          echo "reliability_count=$RELIABILITY_COUNT" >> $GITHUB_OUTPUT
          
          # Save recommendations to file
          echo "$RECOMMENDATIONS" > advisor-recommendations.json
          
          # Create human-readable report
          echo "# Azure Advisor Compliance Report" > advisor-report.md
          echo "" >> advisor-report.md
          echo "**Environment**: DEV" >> advisor-report.md
          echo "**Resource Group**: ${{ secrets.AZURE_RESOURCE_GROUP_NAME }}" >> advisor-report.md
          echo "**Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> advisor-report.md
          echo "" >> advisor-report.md
          echo "## Summary" >> advisor-report.md
          echo "" >> advisor-report.md
          echo "| Category | Count |" >> advisor-report.md
          echo "|----------|-------|" >> advisor-report.md
          echo "| ðŸ”´ High Priority | $HIGH_COUNT |" >> advisor-report.md
          echo "| ðŸŸ¡ Medium Priority | $MEDIUM_COUNT |" >> advisor-report.md
          echo "| ðŸŸ¢ Low Priority | $LOW_COUNT |" >> advisor-report.md
          echo "| **Total** | **$TOTAL_COUNT** |" >> advisor-report.md
          echo "" >> advisor-report.md
          echo "## By Category" >> advisor-report.md
          echo "" >> advisor-report.md
          echo "| Category | Count |" >> advisor-report.md
          echo "|----------|-------|" >> advisor-report.md
          echo "| ðŸ”’ Security | $SECURITY_COUNT |" >> advisor-report.md
          echo "| ðŸ’° Cost | $COST_COUNT |" >> advisor-report.md
          echo "| âš¡ Performance | $PERFORMANCE_COUNT |" >> advisor-report.md
          echo "| ðŸ›¡ï¸ Reliability | $RELIABILITY_COUNT |" >> advisor-report.md
          echo "" >> advisor-report.md
          
          # List all recommendations
          if [ "$TOTAL_COUNT" -gt 0 ]; then
            echo "## Recommendations" >> advisor-report.md
            echo "" >> advisor-report.md
            
            # High priority first
            if [ "$HIGH_COUNT" -gt 0 ]; then
              echo "### ðŸ”´ High Priority" >> advisor-report.md
              echo "" >> advisor-report.md
              echo "$RECOMMENDATIONS" | jq -r '.[] | select(.Impact=="High") | "- **[\(.Category)]** \(.Problem) (`\(.Resource)`)"' >> advisor-report.md
              echo "" >> advisor-report.md
            fi
            
            # Medium priority
            if [ "$MEDIUM_COUNT" -gt 0 ]; then
              echo "### ðŸŸ¡ Medium Priority" >> advisor-report.md
              echo "" >> advisor-report.md
              echo "$RECOMMENDATIONS" | jq -r '.[] | select(.Impact=="Medium") | "- **[\(.Category)]** \(.Problem) (`\(.Resource)`)"' >> advisor-report.md
              echo "" >> advisor-report.md
            fi
            
            # Low priority
            if [ "$LOW_COUNT" -gt 0 ]; then
              echo "### ðŸŸ¢ Low Priority" >> advisor-report.md
              echo "" >> advisor-report.md
              echo "$RECOMMENDATIONS" | jq -r '.[] | select(.Impact=="Low") | "- **[\(.Category)]** \(.Problem) (`\(.Resource)`)"' >> advisor-report.md
              echo "" >> advisor-report.md
            fi
          else
            echo "âœ… **No recommendations found - environment is fully compliant!**" >> advisor-report.md
          fi
          
          cat advisor-report.md
      
      - name: Upload Advisor Report
        uses: actions/upload-artifact@v4
        with:
          name: advisor-report-dev-${{ github.run_number }}
          path: |
            advisor-report.md
            advisor-recommendations.json
          retention-days: 90
      
      - name: Compliance Status Summary
        run: |
          echo "::notice::DEV Environment - Azure Advisor Compliance Check Complete"
          echo "::notice::Total Recommendations: ${{ steps.advisor.outputs.total_count }}"
          echo "::notice::High: ${{ steps.advisor.outputs.high_count }} | Medium: ${{ steps.advisor.outputs.medium_count }} | Low: ${{ steps.advisor.outputs.low_count }}"
          
          if [ "${{ steps.advisor.outputs.high_count }}" -gt "0" ]; then
            echo "::warning::${{ steps.advisor.outputs.high_count }} High priority recommendations require immediate attention"
          fi
          
          if [ "${{ steps.advisor.outputs.security_count }}" -gt "0" ]; then
            echo "::warning::${{ steps.advisor.outputs.security_count }} Security recommendations found"
          fi
      
      - name: Check for High Priority Issues (Optional - Informational Only)
        if: steps.advisor.outputs.high_count > 0
        run: |
          echo "::warning::High priority Azure Advisor recommendations detected in DEV"
          echo "This is informational only - workflow will not fail"
          echo "Review the uploaded artifact for details"
          # Note: We don't fail the workflow, just warn
          # Uncomment the next line if you want to fail on High priority findings:
          # exit 1

  check-advisor-prod:
    name: Check PROD Environment
    runs-on: ubuntu-latest
    environment: prod
    
    steps:
      - name: Azure Login
        run: |
          az login --service-principal \
            --username ${{ secrets.AZURE_CLIENT_ID }} \
            --password ${{ secrets.AZURE_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Get Azure Advisor Recommendations
        id: advisor
        run: |
          # Get all recommendations for the resource group
          echo "Checking PROD resource group: ${{ secrets.AZURE_RESOURCE_GROUP_NAME }}"
          
          RECOMMENDATIONS=$(az advisor recommendation list \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP_NAME }} \
            --query "[].{Category:category, Impact:impact, Problem:shortDescription.problem, Resource:impactedValue}" \
            --output json)
          
          echo "Raw recommendations count: $(echo "$RECOMMENDATIONS" | jq 'length')"
          
          # Count by impact level
          HIGH_COUNT=$(echo "$RECOMMENDATIONS" | jq '[.[] | select(.Impact=="High")] | length')
          MEDIUM_COUNT=$(echo "$RECOMMENDATIONS" | jq '[.[] | select(.Impact=="Medium")] | length')
          LOW_COUNT=$(echo "$RECOMMENDATIONS" | jq '[.[] | select(.Impact=="Low")] | length')
          TOTAL_COUNT=$((HIGH_COUNT + MEDIUM_COUNT + LOW_COUNT))
          
          # Count by category
          SECURITY_COUNT=$(echo "$RECOMMENDATIONS" | jq '[.[] | select(.Category=="Security")] | length')
          COST_COUNT=$(echo "$RECOMMENDATIONS" | jq '[.[] | select(.Category=="Cost")] | length')
          PERFORMANCE_COUNT=$(echo "$RECOMMENDATIONS" | jq '[.[] | select(.Category=="Performance")] | length')
          RELIABILITY_COUNT=$(echo "$RECOMMENDATIONS" | jq '[.[] | select(.Category=="HighAvailability")] | length')
          
          # Set outputs
          echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "medium_count=$MEDIUM_COUNT" >> $GITHUB_OUTPUT
          echo "low_count=$LOW_COUNT" >> $GITHUB_OUTPUT
          echo "total_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
          echo "security_count=$SECURITY_COUNT" >> $GITHUB_OUTPUT
          echo "cost_count=$COST_COUNT" >> $GITHUB_OUTPUT
          echo "performance_count=$PERFORMANCE_COUNT" >> $GITHUB_OUTPUT
          echo "reliability_count=$RELIABILITY_COUNT" >> $GITHUB_OUTPUT
          
          # Save recommendations to file
          echo "$RECOMMENDATIONS" > advisor-recommendations.json
          
          # Create human-readable report
          echo "# Azure Advisor Compliance Report" > advisor-report.md
          echo "" >> advisor-report.md
          echo "**Environment**: PROD" >> advisor-report.md
          echo "**Resource Group**: ${{ secrets.AZURE_RESOURCE_GROUP_NAME }}" >> advisor-report.md
          echo "**Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> advisor-report.md
          echo "" >> advisor-report.md
          echo "## Summary" >> advisor-report.md
          echo "" >> advisor-report.md
          echo "| Category | Count |" >> advisor-report.md
          echo "|----------|-------|" >> advisor-report.md
          echo "| ðŸ”´ High Priority | $HIGH_COUNT |" >> advisor-report.md
          echo "| ðŸŸ¡ Medium Priority | $MEDIUM_COUNT |" >> advisor-report.md
          echo "| ðŸŸ¢ Low Priority | $LOW_COUNT |" >> advisor-report.md
          echo "| **Total** | **$TOTAL_COUNT** |" >> advisor-report.md
          echo "" >> advisor-report.md
          echo "## By Category" >> advisor-report.md
          echo "" >> advisor-report.md
          echo "| Category | Count |" >> advisor-report.md
          echo "|----------|-------|" >> advisor-report.md
          echo "| ðŸ”’ Security | $SECURITY_COUNT |" >> advisor-report.md
          echo "| ðŸ’° Cost | $COST_COUNT |" >> advisor-report.md
          echo "| âš¡ Performance | $PERFORMANCE_COUNT |" >> advisor-report.md
          echo "| ðŸ›¡ï¸ Reliability | $RELIABILITY_COUNT |" >> advisor-report.md
          echo "" >> advisor-report.md
          
          # List all recommendations
          if [ "$TOTAL_COUNT" -gt 0 ]; then
            echo "## Recommendations" >> advisor-report.md
            echo "" >> advisor-report.md
            
            # High priority first
            if [ "$HIGH_COUNT" -gt 0 ]; then
              echo "### ðŸ”´ High Priority" >> advisor-report.md
              echo "" >> advisor-report.md
              echo "$RECOMMENDATIONS" | jq -r '.[] | select(.Impact=="High") | "- **[\(.Category)]** \(.Problem) (`\(.Resource)`)"' >> advisor-report.md
              echo "" >> advisor-report.md
            fi
            
            # Medium priority
            if [ "$MEDIUM_COUNT" -gt 0 ]; then
              echo "### ðŸŸ¡ Medium Priority" >> advisor-report.md
              echo "" >> advisor-report.md
              echo "$RECOMMENDATIONS" | jq -r '.[] | select(.Impact=="Medium") | "- **[\(.Category)]** \(.Problem) (`\(.Resource)`)"' >> advisor-report.md
              echo "" >> advisor-report.md
            fi
            
            # Low priority
            if [ "$LOW_COUNT" -gt 0 ]; then
              echo "### ðŸŸ¢ Low Priority" >> advisor-report.md
              echo "" >> advisor-report.md
              echo "$RECOMMENDATIONS" | jq -r '.[] | select(.Impact=="Low") | "- **[\(.Category)]** \(.Problem) (`\(.Resource)`)"' >> advisor-report.md
              echo "" >> advisor-report.md
            fi
          else
            echo "âœ… **No recommendations found - environment is fully compliant!**" >> advisor-report.md
          fi
          
          cat advisor-report.md
      
      - name: Upload Advisor Report
        uses: actions/upload-artifact@v4
        with:
          name: advisor-report-prod-${{ github.run_number }}
          path: |
            advisor-report.md
            advisor-recommendations.json
          retention-days: 90
      
      - name: Compliance Status Summary
        run: |
          echo "::notice::PROD Environment - Azure Advisor Compliance Check Complete"
          echo "::notice::Total Recommendations: ${{ steps.advisor.outputs.total_count }}"
          echo "::notice::High: ${{ steps.advisor.outputs.high_count }} | Medium: ${{ steps.advisor.outputs.medium_count }} | Low: ${{ steps.advisor.outputs.low_count }}"
          
          if [ "${{ steps.advisor.outputs.high_count }}" -gt "0" ]; then
            echo "::warning::${{ steps.advisor.outputs.high_count }} High priority recommendations require immediate attention"
          fi
          
          if [ "${{ steps.advisor.outputs.security_count }}" -gt "0" ]; then
            echo "::warning::${{ steps.advisor.outputs.security_count }} Security recommendations found"
          fi
      
      - name: Check for High Priority Issues (Optional - Informational Only)
        if: steps.advisor.outputs.high_count > 0
        run: |
          echo "::warning::High priority Azure Advisor recommendations detected in PROD"
          echo "This is informational only - workflow will not fail"
          echo "Review the uploaded artifact for details"
          # Note: We don't fail the workflow, just warn
          # Uncomment the next line if you want to fail on High priority findings:
          # exit 1
