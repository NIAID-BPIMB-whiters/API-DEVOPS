name: Run - Publisher

permissions:
  actions: write
  contents: read

on:
  # Triggers the workflow on push events but only for the main branch
  push:
    branches: [main]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      COMMIT_ID_CHOICE:
        description: 'Choose "publish-all-artifacts-in-repo" only when you want to force republishing all artifacts (e.g. after build failure). Otherwise stick with the default behavior of "publish-artifacts-in-last-commit"'
        required: true
        type: choice
        default: "publish-artifacts-in-last-commit"
        options:
          - "publish-artifacts-in-last-commit"
          - "publish-all-artifacts-in-repo"

jobs:
  # Manual approval gate before DEV deployment
  approve-dev-deployment:
    runs-on: ubuntu-latest
    environment: 
      name: approve-dev  # Create this environment with required reviewers
    steps:
      - name: DEV deployment approved
        run: echo "Proceeding with DEV deployment..."

  get-commit:
    needs: approve-dev-deployment
    runs-on: ubuntu-latest
    steps:
      # Set the COMMIT_ID env variable
      - name: Set the Commit Id
        id: commit
        run: echo "commit_id=${GITHUB_SHA}" >> $GITHUB_OUTPUT
    outputs:
      commit_id: ${{ steps.commit.outputs.commit_id }}

  #Deploy to DEV with Commit ID (only changed artifacts from last commit)
  # Pipeline: DAIDS_DEV → Repository → DEV → QA
  Deploy-To-DEV-With-Commit-ID:
    if: (github.event.inputs.COMMIT_ID_CHOICE == 'publish-artifacts-in-last-commit' || github.event.inputs.COMMIT_ID_CHOICE == '')
    needs: get-commit
    uses: ./.github/workflows/run-publisher-with-env.yaml
    with:
      API_MANAGEMENT_ENVIRONMENT: dev # Deploys to DEV APIM service (niaid-bpimb-apim-dev)
      COMMIT_ID: ${{ needs.get-commit.outputs.commit_id }}
      CONFIGURATION_YAML_PATH: configuration.dev.yaml # DEV deployment configuration
      API_MANAGEMENT_SERVICE_OUTPUT_FOLDER_PATH: apimartifacts # Artifacts extracted from DAIDS_DEV environment
    secrets: inherit

  #Deploy to DEV without Commit ID (all artifacts in repo)
  # Use this option for full redeployment of all artifacts to DEV
  Deploy-To-DEV-Without-Commit-ID:
    if: ( github.event.inputs.COMMIT_ID_CHOICE == 'publish-all-artifacts-in-repo' )
    needs: get-commit
    uses: ./.github/workflows/run-publisher-with-env.yaml
    with:
      API_MANAGEMENT_ENVIRONMENT: dev # Deploys to DEV APIM service (niaid-bpimb-apim-dev)
      CONFIGURATION_YAML_PATH: configuration.dev.yaml # DEV deployment configuration
      API_MANAGEMENT_SERVICE_OUTPUT_FOLDER_PATH: apimartifacts # All artifacts extracted from DAIDS_DEV environment
    secrets: inherit

  # Run full test suite on DEV after successful deployment
  Test-DEV-After-Deploy:
    needs: [Deploy-To-DEV-With-Commit-ID, Deploy-To-DEV-Without-Commit-ID]
    if: always() && (needs.Deploy-To-DEV-With-Commit-ID.result == 'success' || needs.Deploy-To-DEV-Without-Commit-ID.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Trigger and wait for API tests in DEV
        run: |
          # Trigger the test workflow
          gh workflow run test-apis-ephemeral.yaml \
            -f ENVIRONMENT=dev \
            -f TEST_TYPE=full-suite \
            --repo ${{ github.repository }}
          
          # Wait for workflow to start (max 30 seconds)
          echo "Waiting for test workflow to start..."
          for i in {1..30}; do
            RUN_ID=$(gh run list --workflow=test-apis-ephemeral.yaml --repo ${{ github.repository }} --limit 1 --json databaseId --jq '.[0].databaseId')
            if [ -n "$RUN_ID" ]; then
              echo "Test workflow started with ID: $RUN_ID"
              break
            fi
            sleep 1
          done
          
          # Wait for the workflow to complete (max 10 minutes)
          if [ -n "$RUN_ID" ]; then
            echo "Waiting for test workflow to complete..."
            gh run watch $RUN_ID --repo ${{ github.repository }} --exit-status
          else
            echo "Error: Test workflow did not start"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  # Manual approval gate before QA deployment
  approve-qa-deployment:
    if: always() && needs.Test-DEV-After-Deploy.result == 'success'
    needs: Test-DEV-After-Deploy
    runs-on: ubuntu-latest
    environment:
      name: approve-qa  # Create this environment with required reviewers
    steps:
      - name: QA deployment approved
        run: echo "Proceeding with QA deployment..."

  #Deploy to QA with Commit ID (only changed artifacts from last commit)
  # Pipeline: DAIDS_DEV → Repository → DEV → QA
  Deploy-To-QA-With-Commit-ID:
    if: (github.event_name == 'push' || github.event.inputs.COMMIT_ID_CHOICE == 'publish-artifacts-in-last-commit' || !github.event.inputs.COMMIT_ID_CHOICE) && needs.approve-qa-deployment.result == 'success'
    needs: [get-commit, approve-qa-deployment]
    uses: ./.github/workflows/run-publisher-with-env.yaml
    with:
      API_MANAGEMENT_ENVIRONMENT: qa # Deploys to QA APIM service (niaid-bpimb-apim-qa)
      COMMIT_ID: ${{ needs.get-commit.outputs.commit_id }}
      CONFIGURATION_YAML_PATH: configuration.qa.yaml # QA deployment configuration
      API_MANAGEMENT_SERVICE_OUTPUT_FOLDER_PATH: apimartifacts # Artifacts extracted from DAIDS_DEV environment
    secrets: inherit

  #Deploy to QA without Commit ID (all artifacts in repo)
  # Use this option for full redeployment of all artifacts to QA
  Deploy-To-QA-Without-Commit-ID:
    if: (github.event.inputs.COMMIT_ID_CHOICE == 'publish-all-artifacts-in-repo') && needs.approve-qa-deployment.result == 'success'
    needs: [get-commit, approve-qa-deployment]
    uses: ./.github/workflows/run-publisher-with-env.yaml
    with:
      API_MANAGEMENT_ENVIRONMENT: qa # Deploys to QA APIM service (niaid-bpimb-apim-qa)
      CONFIGURATION_YAML_PATH: configuration.qa.yaml # QA deployment configuration
      API_MANAGEMENT_SERVICE_OUTPUT_FOLDER_PATH: apimartifacts # All artifacts extracted from DAIDS_DEV environment
    secrets: inherit

  # Run full test suite on QA after successful deployment
  Test-QA-After-Deploy:
    needs: [Deploy-To-QA-With-Commit-ID, Deploy-To-QA-Without-Commit-ID]
    if: always() && (needs.Deploy-To-QA-With-Commit-ID.result == 'success' || needs.Deploy-To-QA-Without-Commit-ID.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Trigger and wait for API tests in QA
        run: |
          # Trigger the test workflow
          gh workflow run test-apis-ephemeral.yaml \
            -f ENVIRONMENT=qa \
            -f TEST_TYPE=full-suite \
            --repo ${{ github.repository }}
          
          # Wait for workflow to start (max 30 seconds)
          echo "Waiting for test workflow to start..."
          for i in {1..30}; do
            RUN_ID=$(gh run list --workflow=test-apis-ephemeral.yaml --repo ${{ github.repository }} --limit 1 --json databaseId --jq '.[0].databaseId')
            if [ -n "$RUN_ID" ]; then
              echo "Test workflow started with ID: $RUN_ID"
              break
            fi
            sleep 1
          done
          
          # Wait for the workflow to complete (max 10 minutes)
          if [ -n "$RUN_ID" ]; then
            echo "Waiting for test workflow to complete..."
            gh run watch $RUN_ID --repo ${{ github.repository }} --exit-status
          else
            echo "Error: Test workflow did not start"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  # Optional: Check Azure Advisor compliance after deployment
  # Uncomment to enable post-deployment compliance checks
  # Check-Advisor-Compliance:
  #   needs: Test-PROD-After-Deploy
  #   if: needs.Test-PROD-After-Deploy.result == 'success'
  #   runs-on: ubuntu-latest
  #   environment: prod
  #   steps:
  #     - name: Trigger Advisor compliance check
  #       run: |
  #         gh workflow run check-advisor.yaml \
  #           -f ENVIRONMENT=prod \
  #           --repo ${{ github.repository }}
  #       env:
  #         GH_TOKEN: ${{ github.token }}
