name: Promote from Sandbox to DEV

on:
  workflow_dispatch:
    inputs:
      API_NAMES:
        description: 'API names (comma-separated) or "ALL"'
        required: true
        type: string
      OVERWRITE_EXISTING:
        description: 'Allow overwriting APIs in DEV?'
        required: true
        type: choice
        default: 'false'
        options:
          - 'false'
          - 'true'

env:
  apiops_release_version: v6.0.2

permissions:
  id-token: write
  contents: read

jobs:
  extract-from-sandbox:
    name: Extract from Sandbox
    runs-on: ubuntu-latest
    environment: apim-bpimb-sb
    steps:
      - uses: actions/checkout@v4
      
      - name: Create extraction config
        run: |
          if [ "${{ github.event.inputs.API_NAMES }}" = "ALL" ]; then
            cat > extraction-config.yaml << 'EOF'
          apimSpecification:
            name: ${{ secrets.API_MANAGEMENT_SERVICE_NAME }}
          apiSpecification:
            format: OpenAPIV3Yaml
          EOF
          else
            cat > extraction-config.yaml << 'EOF'
          apimSpecification:
            name: ${{ secrets.API_MANAGEMENT_SERVICE_NAME }}
          apiSpecification:
            format: OpenAPIV3Yaml
          apis:
          EOF
            echo "${{ github.event.inputs.API_NAMES }}" | tr ',' '\n' | while read api; do
              echo "  - name: $api" >> extraction-config.yaml
            done
          fi
          cat extraction-config.yaml
      
      - name: Run extractor
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_RESOURCE_GROUP_NAME: ${{ secrets.AZURE_RESOURCE_GROUP_NAME }}
          API_MANAGEMENT_SERVICE_NAME: ${{ secrets.API_MANAGEMENT_SERVICE_NAME }}
          API_MANAGEMENT_SERVICE_OUTPUT_FOLDER_PATH: ${{ github.workspace }}/extracted
          CONFIGURATION_YAML_PATH: ${{ github.workspace }}/extraction-config.yaml
        run: |
          wget -O extractor.zip https://github.com/Azure/apiops/releases/download/${{ env.apiops_release_version }}/extractor-linux-x64.zip
          unzip extractor.zip
          chmod +x ./extractor
          ./extractor
      
      - uses: actions/upload-artifact@v4
        with:
          name: extracted-apis
          path: extracted/
          retention-days: 1

  check-conflicts:
    name: Check DEV conflicts
    runs-on: ubuntu-latest
    needs: extract-from-sandbox
    environment: apim-bpimb-dev
    if: github.event.inputs.OVERWRITE_EXISTING == 'false'
    steps:
      - uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'
      
      - name: Check APIs
        run: |
          if [ "${{ github.event.inputs.API_NAMES }}" = "ALL" ]; then
            exit 0
          fi
          
          IFS=',' read -ra APIS <<< "${{ github.event.inputs.API_NAMES }}"
          CONFLICTS=""
          
          for api in "${APIS[@]}"; do
            api=$(echo "$api" | xargs)
            if az apim api show --resource-group nih-niaid-azurestrides-dev-rg-apim-az --service-name niaid-bpimb-apim-dev --api-id "$api" 2>/dev/null; then
              CONFLICTS="$CONFLICTS $api"
            fi
          done
          
          if [ -n "$CONFLICTS" ]; then
            echo "ERROR: APIs exist in DEV:$CONFLICTS"
            exit 1
          fi

  deploy-to-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    needs: [extract-from-sandbox, check-conflicts]
    if: always() && needs.extract-from-sandbox.result == 'success' && (needs.check-conflicts.result == 'success' || needs.check-conflicts.result == 'skipped')
    environment: apim-bpimb-dev
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/download-artifact@v4
        with:
          name: extracted-apis
          path: artifacts
      
      - name: Filter artifacts to only specified APIs
        run: |
          # If not ALL, keep only the specified APIs
          if [ "${{ github.event.inputs.API_NAMES }}" != "ALL" ]; then
            cd artifacts/apis
            # Get list of API names to keep
            IFS=',' read -ra KEEP_APIS <<< "${{ github.event.inputs.API_NAMES }}"
            
            # Remove all APIs except the ones we want
            for dir in */; do
              dir_name="${dir%/}"
              keep=false
              for api in "${KEEP_APIS[@]}"; do
                api=$(echo "$api" | xargs)  # trim whitespace
                if [ "$dir_name" = "$api" ]; then
                  keep=true
                  break
                fi
              done
              
              if [ "$keep" = false ]; then
                echo "Removing API: $dir_name"
                rm -rf "$dir_name"
              else
                echo "Keeping API: $dir_name"
              fi
            done
            cd ../..
          fi
          
          echo "APIs to deploy:"
          ls -la artifacts/apis/
      
      - name: Create publisher configuration
        run: |
          # Simple config - just set the target APIM service name
          cat > publisher-config.yaml << 'EOF'
          apimServiceName: ${{ secrets.API_MANAGEMENT_SERVICE_NAME }}
          EOF
          
          echo "Publisher configuration:"
          cat publisher-config.yaml
      
      - name: Deploy
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_RESOURCE_GROUP_NAME: ${{ secrets.AZURE_RESOURCE_GROUP_NAME }}
          API_MANAGEMENT_SERVICE_NAME: ${{ secrets.API_MANAGEMENT_SERVICE_NAME }}
          API_MANAGEMENT_SERVICE_OUTPUT_FOLDER_PATH: ${{ github.workspace }}/artifacts
          CONFIGURATION_YAML_PATH: ${{ github.workspace }}/publisher-config.yaml
        run: |
          wget -O publisher.zip https://github.com/Azure/apiops/releases/download/${{ env.apiops_release_version }}/publisher-linux-x64.zip
          unzip publisher.zip
          chmod +x ./publisher
          ./publisher
